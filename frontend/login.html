<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Login - ClassLedger by Tarka</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo-container">
                <img src="assets/logo.svg" alt="ClassLedger" class="header-logo">
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="card" style="max-width: 500px; margin: 3rem auto;">
                <div class="text-center">
                    <h1 style="margin-bottom: 1rem;">Login to ClassLedger</h1>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        Sign in with your Google account to access the attendance system.
                        Only authorized school staff can access this system.
                    </p>
                </div>

                <div id="loginStatus" class="alert alert-info" style="display: none;"></div>

                <div class="text-center">
                    <button id="loginBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                        Sign in with Google
                    </button>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        You will be redirected to Google's sign-in page.
                    </p>
                    <a href="index.html" style="color: var(--primary-color); text-decoration: none;">
                        ‚Üê Back to Homepage
                    </a>
                </div>
            </div>

            <div class="card" style="max-width: 500px; margin: 0 auto;">
                <h3 style="margin-bottom: 1rem;">Access Requirements</h3>
                <ul style="line-height: 2; margin-left: 2rem;">
                    <li>Your Google email must be registered in the system</li>
                    <li>Your account must be marked as active</li>
                    <li>You must have an assigned role (Teacher, Admin, or Principal)</li>
                </ul>
                <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                    If you believe you should have access, please contact your school administrator.
                </p>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2024 ClassLedger by Tarka</p>
            <p>Powered by Tarka</p>
        </div>
    </footer>

    <!-- Load Supabase library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth-supabase.js"></script>
    <script src="js/onboarding-check.js"></script>
    <script>
        // Handle Supabase OAuth callback
        document.addEventListener('DOMContentLoaded', async function() {
            const supabase = getSupabase();
            if (!supabase) {
                console.error('Supabase not initialized');
                return;
            }

            // Check for OAuth callback
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            if (session && !sessionError) {
                // User is authenticated, check their role and redirect
                console.log('‚úÖ OAuth session found, authenticating user...');
                const authResult = await authenticateUser();
                console.log('üîê Authentication result:', authResult);
                if (authResult.success) {
                    console.log('‚úÖ Authentication successful, redirecting to:', authResult.redirect);
                    window.location.href = authResult.redirect;
                    return;
                } else {
                    // Show access denied
                    console.error('‚ùå Authentication failed:', authResult.error);
                    showAccessDenied(authResult.error || 'Access denied');
                    return;
                }
            }

            // Check if already logged in from sessionStorage
            const userStr = sessionStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    const redirectMap = {
                        'product_admin': 'product-admin-dashboard.html',
                        'admin': 'admin-dashboard.html',
                        'teacher': 'teacher-dashboard.html',
                        'principal': 'principal-dashboard.html'
                    };
                    const redirect = redirectMap[user.role] || redirectMap[user.type] || 'index.html';
                    window.location.href = redirect;
                    return;
                } catch (e) {
                    console.error('Error parsing user from sessionStorage:', e);
                    sessionStorage.clear();
                }
            }

            // Initialize login button
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    const statusEl = document.getElementById('loginStatus');
                    if (statusEl) {
                        statusEl.style.display = 'block';
                        statusEl.className = 'alert alert-info';
                        statusEl.textContent = 'Redirecting to Google sign-in...';
                    }
                    
                    // Sign in with Google via Supabase
                    const result = await signInWithGoogle();
                    if (!result.success) {
                        if (statusEl) {
                            statusEl.className = 'alert alert-danger';
                            statusEl.textContent = 'Error: ' + (result.error || 'Failed to sign in');
                        }
                    }
                    // If successful, signInWithGoogle will redirect to Google OAuth
                });
            }
        });

        // Helper function to show access denied
        function showAccessDenied(message) {
            const main = document.querySelector('main');
            if (main) {
                main.innerHTML = `
                    <div class="container">
                        <div class="card" style="max-width: 500px; margin: 3rem auto;">
                            <div class="text-center">
                                <h1 style="color: var(--danger-color, #dc3545); margin-bottom: 1rem;">Access Denied</h1>
                                <p style="font-size: 1.125rem; margin-bottom: 2rem;">
                                    ${message || 'You are not authorized to use ClassLedger.'}
                                </p>
                                <p style="color: var(--text-secondary, #666); margin-bottom: 2rem;">
                                    Please contact your school administrator to be added to the system.
                                </p>
                                <a href="index.html" class="btn btn-primary">Return to Homepage</a>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>

